name: B站爬虫任务

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  run-bilibili-crawler:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # 添加超时保护
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 安装系统依赖 (修正版)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3 \
          libnspr4 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libcups2 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libxss1 \
          libgtk-3-0 \
          libasound2 \
          libgl1  # 使用libgl1替代libgl1-mesa-glx
        
    - name: 安装Python依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 selenium  # 先安装基础包测试
        
    - name: 安装Playwright浏览器
      run: |
        python -m playwright install --with-deps chromium
        
    - name: 执行B站爬虫 (简化测试版)
      run: |
        echo "=== 开始执行爬虫 ==="
        python -c "
import sys
import os
sys.path.append('.')

print('1. 检查Python环境...')
print('Python版本:', sys.version)
print('当前目录:', os.getcwd())

print('2. 列出项目文件...')
for item in os.listdir('.'):
    if item.endswith('.py') or item in ['media_platform', 'config']:
        print(f'  {item}')

print('3. 测试完成 - 准备执行真实爬虫')
        "
        
        # 执行真实爬虫
        python run_bilibili.py
        python -m playwright install-deps
        
    - name: 执行B站爬虫
      run: python run_bilibili.py
